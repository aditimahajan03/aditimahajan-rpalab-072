(window.odspNextWebpackJsonp=window.odspNextWebpackJsonp||[]).push([["348"],{"1275":function(e,t,n){"use strict";n.d(t,"t",function(){return r});n.d(t,"e",function(){return i});n.d(t,"n",function(){return s});var r,i,s;(function(e){e[e.WebhookSubscription=0]="WebhookSubscription";e[e.Meta=1]="Meta";e[e.EventHub=2]="EventHub"})(r||(r={}));(function(e){e[e.DriveStatusChange=0]="DriveStatusChange";e[e.QuotaAllowanceChange=1]="QuotaAllowanceChange";e[e.QuotaStateChange=2]="QuotaStateChange";e[e.Zip=3]="Zip";e[e.ProfileChange=4]="ProfileChange"})(i||(i={}));(function(e){e[e.PushChannelProvider=0]="PushChannelProvider";e[e.ItemAutoRefreshProvider=1]="ItemAutoRefreshProvider";e[e.ItemAutoRefreshDataSource=2]="ItemAutoRefreshDataSource"})(s||(s={}))},"1520":function(e,t,n){"use strict";var r=n(37),i=(function(){function e(){}e.IsProblematicLocale=function(t){null===e._problematicLocalesMap&&e.InitializeProblematicLocales();t&&(t=t.toLowerCase());return e._problematicLocalesMap[t]};e.convertToLocaleDateString=function(e,t){void 0===t&&(t="en-us");try{var n=t.toLocaleLowerCase();return new Date(e).toLocaleDateString(n)}catch(e){return}};e.convertToDateString=function(e){var t=new RegExp(/(\d{4})\-(\d{1,2})\-(\d{1,2})/);if(e&&e.match(t))return e.replace(t,"$2/$3/$1")};e.convertToDayMonth=function(e,t){void 0===t&&(t="en-us");try{var n=t.toLocaleLowerCase(),i=new Date(e),s=i.toLocaleString(n,{month:"short"});return r.format("{0}. {1}",i.getDate(),s)}catch(e){return}};e.convertToMonthDayYear=function(e,t){void 0===t&&(t="en-us");try{var n=t.toLocaleLowerCase(),i=new Date(e),s=i.toLocaleString(n,{month:"long"});return r.format("{0} {1}, {2}",s,i.getDate(),i.getFullYear())}catch(e){return}};e.convertToLocaleString=function(e,t){void 0===t&&(t="en-us");try{var n=t.toLocaleLowerCase();return new Date(e).toLocaleString(n)}catch(e){return}};e.getLongDateStringSafe=function(t,n){if(t){var r=new Date(t);if(r&&!isNaN(r.getTime())){try{if(!e.IsProblematicLocale(n))return r.toLocaleDateString(n,e._longDateFormatOptions)}catch(e){}return r.toLocaleDateString("en",e._longDateFormatOptions)}}};e.getDaysFromToday=function(e){var t=new Date(e).getTime()-(new Date).getTime();return Math.floor(t/864e5)};e.InitializeProblematicLocales=function(){e._problematicLocalesMap={};try{for(var t={month:"long"},n=0,r=e._chromeProblematicLocales;n<r.length;n++){var i=r[n];(new Date).toLocaleDateString(i,t).match("M[0-9][0-9]")&&(e._problematicLocalesMap[i]=!0)}}catch(e){}};e._chromeProblematicLocales=["eu-es","af-za","az-latn-az","bs-latn-ba","cy-gb","ga-ie","gl-es","ha-latn-ng","hy-am","ig-ng","is-is","ka-ge","kk-kz","km-kh","ky-kg","mk-mk","mn-mn","mt-mt","ne-np","nn-no","or-in","pa-in","si-lk","sq-al","ur-pk","uz-latn-uz","yo-ng","zu-za","pa-arab-pk","ku-arab-iq","be-by","rw-rw","ti-et","tg-cyrl-tj","eu","af","az","bs","cy","ga","gl","ha","hy","ig","is","ka","kk","km","ky","mk","mn","mt","ne","nn","or","pa","si","sq","ur","uz","yo","zu","pa","ku","be","rw","ti"];e._longDateFormatOptions={year:"numeric",month:"long",day:"numeric"};e._problematicLocalesMap=null;return e})();t.e=i},"1569":function(e,t,n){"use strict";var r;(function(e){e[e.unknown=0]="unknown";e[e.inactive=1]="inactive";e[e.delinquent=2]="delinquent";e[e.other=3]="other"})(r||(r={}));t.e=r},"2767":function(e,t,n){"use strict";n.r(t);var r,i=n(0),s=n(25),o=n(83),u=n(7),a=n(45),f=n(157),l=n(129),c="normal",h="nearing",p="critical",d="exceeded",v=(function(e){Object(i.__extends)(t,e);function t(t){var n=e.call(this,t)||this;n._data=t.data;n.total=n.createPureComputed(n._computeTotal);n.status=n.createPureComputed(n._computeStatus);n.used=n.createPureComputed(n._computeUsed);n.overage=n.createPureComputed(n._computeOverage);n.remaining=n.createPureComputed(n._computeRemaining);n.usedPercentage=n.createPureComputed(n._computeUsedPercentage);n.canUpgrade=n.createPureComputed(n._computeCanUpgrade);return n}t.prototype._computeTotal=function(){var e=this._data();if(e&&e.quota)return e.quota.total};t.prototype._computeUsed=function(){var e=this._data();if(e&&e.quota){var t=e.quota.used;this.status()===f.e.full&&t>e.quota.total&&(t=e.quota.total);return t}};t.prototype._computeOverage=function(){var e=this._data();if(e&&e.quota){var t=e.quota.used-e.quota.total;return l.e.getDisplayString(t)}};t.prototype._computeRemaining=function(){var e=this._data();if(e&&e.quota){var t=Math.max(e.quota.total-e.quota.used,0);return l.e.getDisplayString(t)}};t.prototype._computeStatus=function(){var e=this._data();if(!e||!e.quota||!e.status)return f.e.unknown;var t=!e.quota.storagePlans.upgradeAvailable,n=!!e.status.lockdownDateTime,r=this._isExcludedFromLockdown(e.status.lockdownDateTime),i=this._isDelinquent(e.status.lockdownReasons);switch(e.quota.state){case c:case h:return f.e.normal;case p:return f.e.critical;case d:return"lockedDown"===e.status.state&&i?f.e.overQuota:n?r?f.e.outOfSpace:f.e.overQuota:t?f.e.outOfSpace:f.e.full}return f.e.unknown};t.prototype._isExcludedFromLockdown=function(e){if(e){if(9999===new Date(e).getFullYear())return!0}return!1};t.prototype._isDelinquent=function(e){return!(!e||!e.length)&&e.indexOf("delinquent")>=0};t.prototype._computeUsedPercentage=function(){var e=this._data();if(!e||!e.quota||!e.quota.total)return 0;var t=(e.quota.total-e.quota.remaining)/e.quota.total*100;return Math.min(t,99)};t.prototype._computeCanUpgrade=function(){var e=this._data();if(e&&e.quota){var t=e.quota.storagePlans;return t?t.upgradeAvailable:e.quota.total<1099511627776}return!1};return t})(u.n),m=n(105),g=n(284),y=(function(e){Object(i.__extends)(t,e);function t(t){void 0===t&&(t={});return e.call(this,t)||this}t.prototype.monitor=function(e){var t=this;if(!e)return s.n.wrapError(new Error("There was no monitor url provided."));var n=new m.e,r=this.async.setInterval(function(){g.e.start({url:e}).then(function(e){if(r&&!t._checkStatus(e,n)){t.async.clearInterval(r);r=null}})},3e4);return n.getPromise()};t.prototype._checkStatus=function(e,t){var n,r=e?e.responseText:"No request returned";if(e&&e.responseText)try{n=JSON.parse(e.responseText)}catch(e){}if(n.quota){t.complete();return!1}if(!n||!n.status){t.error(new Error("Unexpected response: "+r));return!1}switch(n.status){default:case"notStarted":case"inProgress":case"updating":case"deletePending":case"waiting":return!0;case"completed":t.complete();return!1;case"failed":case"deleteFailed":t.error(new Error("Operation failed: "+r));return!1}};return t})(u.n),b=n(1569),w=n(1520),E="inactive",S="delinquent",x=(function(e){Object(i.__extends)(t,e);function t(t){var n=e.call(this,t)||this;n._data=t.data;n.accountState=n.createPureComputed(n._computeAccountState);n.primaryLockedReason=n.createPureComputed(n._computePrimaryLockedReason);n.lockdownDate=n.createPureComputed(n._computeLockdownDate);n.driveDeletionDate=n.createPureComputed(n._computeDriveDeletionDate);n.userUnlocksRemaining=n.createPureComputed(n._computeUserUnlocksRemaining);n.lastUnlockDate=n.createPureComputed(n._computeLastUnlockDate);n.isSoftLocked=n.createPureComputed(n._computeIsSoftLocked);n.isTemporararilyUnfrozen=n.createPureComputed(n._computeIsTemporararilyUnfrozen);n.isGoingToBeLockedSoon=n.createPureComputed(n._computeIsGoingToBeLockedSoon);n.isUnlockInProgress=n.createObservable(!1);n.createBackgroundComputed(n._computeIsUnlockInProgress);return n}t.prototype._computeAccountState=function(){var e=this._data();return e&&e.status?"active"===e.status.state?1:2:0};t.prototype._computeIsSoftLocked=function(){var e=this._data();return!(!e||!e.status)&&("lockedDown"===e.status.state&&"restricted"===e.status.lockdownItemAccess)};t.prototype._computeIsTemporararilyUnfrozen=function(){var e=this._data();return e&&e.status&&e.status.lockdownDateTime&&"active"===e.status.state&&0===e.status.userUnlocksRemaining};t.prototype._computeIsGoingToBeLockedSoon=function(){var e=this._data();return e&&e.status&&e.status.lockdownDateTime&&"active"===e.status.state&&w.e.getDaysFromToday(e.status.lockdownDateTime)<=30};t.prototype._computePrimaryLockedReason=function(){var e=this._data();if(e&&e.status){for(var t=!1,n=!1,r=0,i=e.status.lockdownReasons||[];r<i.length;r++){var s=i[r];if(s===S)n=!0;else{if(s!==E)return b.e.other;t=!0}}if(n)return b.e.delinquent;if(t)return b.e.inactive}return b.e.unknown};t.prototype._computeLockdownDate=function(){var e=this._data();return e&&e.status&&e.status.lockdownDateTime?e.status.lockdownDateTime:""};t.prototype._computeDriveDeletionDate=function(){var e=this._data();return e&&e.status&&e.status.driveDeletionDateTime?e.status.driveDeletionDateTime:""};t.prototype._computeLastUnlockDate=function(){var e=this._data();return e&&e.status&&e.status.lastUnlockDateTime?e.status.lastUnlockDateTime:""};t.prototype._computeUserUnlocksRemaining=function(){var e=this._data();if(e&&e.status)return e.status.userUnlocksRemaining};t.prototype._computeIsUnlockInProgress=function(){var e=this._data();if(e&&e.status){var t=e.status.pendingOperation;if(t&&t.type&&t.status&&"unlockdrive"===t.type.toLowerCase()&&"inprogress"===t.status.toLowerCase()){this.isUnlockInProgress(!0);return}}this.isUnlockInProgress(!1)};return t})(u.n),T=n(15);(function(e){e[e.normalLow=1]="normalLow";e[e.normalHigh=2]="normalHigh";e[e.inactive=3]="inactive";e[e.criticalLow=4]="criticalLow";e[e.criticalHigh=5]="criticalHigh";e[e.exceededLow=6]="exceededLow";e[e.exceededHigh=7]="exceededHigh";e[e.exceededLowCold=8]="exceededLowCold";e[e.exceededHighCold=9]="exceededHighCold";e[e.delinquentLow=10]="delinquentLow";e[e.delinquentHigh=11]="delinquentHigh";e[e.delinquentAgain=12]="delinquentAgain";e[e.delinquentSoftLocked=13]="delinquentSoftLocked"})(r||(r={}));var N=(function(e){Object(i.__extends)(t,e);function t(t){void 0===t&&(t={});var n=e.call(this,t)||this;n._quotaDataSource=n.resources.consume(T.Q);n.userDriveData=n.createObservable(null);n._exposeDebuggingTools();return n}t.prototype.updateUserState=function(){var e=this;if(this._updateTimeout)this._needsUpdate=!0;else{this._needsUpdate=!1;this._requestUserDriveData();this._updateTimeout=this.async.setTimeout(function(){e._updateTimeout=null;e._needsUpdate&&e.updateUserState()},3e4)}};t.prototype._requestUserDriveData=function(){var e=this;this._quotaDataSource.getQuotaInfo().then(function(t){e._updateUserDriveData(t)},function(e){}).done()};t.prototype._updateUserDriveData=function(e){if(!e)return null;if(e.quota){var t=e.quota;t.used=t.used||t.total-t.remaining;t.remaining=t.remaining>0?t.remaining:0}return this.userDriveData(e)};t.prototype._exposeDebuggingTools=function(){};t.prototype._getMessage=function(e){switch(e){case r.normalLow:return'NormalLow: Quota status is "normal" and the user does not have an office subscription.';case r.normalHigh:return'NormalHigh: Quota status is "normal" and the user has an office subscription.';case r.inactive:return"Inactive: The user's account has been locked due to inactivity.";case r.criticalLow:return'CriticalLow: Quota status is "critical" and the user does not have an office subscription.';case r.criticalHigh:return'CriticalHigh: Quota status is "critical" and the user has an office subscription.';case r.exceededLow:return'ExceededLow: Quota status is "exceeded" and the user does not have an office subscription.';case r.exceededHigh:return'ExceededHigh: Quota status is "exceeded" and the user has an office subscription.';case r.exceededLowCold:return'ExceededLowCold: Quota status is "exceeded" and the user does not have an office subscription. The user\'s account has been marked to be locked soon.';case r.exceededHighCold:return'ExceededHighCold: Quota status is "exceeded" and the user has an office subscription. The user\'s account has been marked to be locked soon.';case r.delinquentLow:return'DelinquentLow: Quota status is "exceeded" and the user does not have an office subscription. The user\'s account has been locked due to deliquency.';case r.delinquentHigh:return'DelinquentHigh: Quota status is "exceeded" and the user has an office subscription. The user\'s account has been locked due to deliquency.';case r.delinquentAgain:return'DelinquentAgain: Quota status is "exceeded" and the user does not have an office subscription. The user\'s account has been locked due to deliquency for the second time.';case r.delinquentSoftLocked:return"Account is soft locked for being over quota."}};t.prototype._updateData=function(e,t){var n=e.status,i=e.quota;if(t>=r.normalLow&&t<=r.inactive){i.state="normal";i.used=parseFloat((i.total/2).toFixed(2))}if(t===r.criticalLow||t===r.criticalHigh){i.state="critical";i.used=i.total-1}if(t>=r.exceededLow&&t<=r.delinquentSoftLocked){i.state="exceeded";i.used=parseFloat((1.2*i.total).toFixed(2))}i.remaining=i.total-i.used;if(t===r.exceededLowCold||t===r.exceededHighCold){var s=new Date;s.setDate(s.getDate()+7);e.status.lockdownDateTime=s.toISOString()}else e.status.lockdownDateTime=void 0;i.storagePlans.upgradeAvailable=!(t===r.normalHigh||t===r.criticalHigh||t===r.exceededHigh||t===r.exceededHighCold||t===r.delinquentHigh);if(t===r.inactive||t>=r.delinquentLow&&t<=r.delinquentSoftLocked){e.status.state="lockedDown";e.status.userUnlocksRemaining=t===r.delinquentAgain?0:1;var o=new Date;o.setDate(o.getDate()-30);e.status.lastUnlockDateTime=o.toISOString();o.setDate(o.getDate()+60);e.status.driveDeletionDateTime=o.toISOString();e.status.lockdownReasons=t===r.inactive?["inactive"]:["delinquent"];t===r.delinquentSoftLocked?e.status.lockdownItemAccess="restricted":e.status.lockdownItemAccess="denied"}else{n.state="active";e.status.lockdownReasons=[]}};return t})(u.n),C=n(108),k=n(352),L=Object(C.e)({eventName:"QuotaUsage,Engagement,",shortEventName:"QuotaUsage"},{quotaStatus:1,quotaTotal:2,quotaUsed:2,accountState:1},k.e),A=n(1299),O=n(1351),M=n(400),_=n(1275),D=n(1519),P="microsoft.od.unlocking.monitor",H=(function(e){Object(i.__extends)(t,e);function t(t){void 0===t&&(t={});var n=e.call(this,t)||this;n._quotaDataSource=n.resources.consume(T.Q);n._operationMonitor=new(n.managed(y));n._dataStore=new o.e("UserStateProvider",a.e.local);n._requester=new(n.managed(N));n._requester.updateUserState();n._needsUpdate=n.resources.consume(M.e);n.resources.consumeAsync(D.e).then(function(e){e.setupNotificationHandler({source:_.t.WebhookSubscription,scenarios:[_.e.DriveStatusChange,_.e.QuotaAllowanceChange,_.e.QuotaStateChange]},function(){n._needsUpdate(!0)})});var r=new(n.managed(x))({data:n._requester.userDriveData});n.accountState=r.accountState;n.primaryLockedReason=r.primaryLockedReason;n.lockdownDate=r.lockdownDate;n.driveDeletionDate=r.driveDeletionDate;n.userUnlocksRemaining=r.userUnlocksRemaining;n.lastUnlockDate=r.lastUnlockDate;n.isSoftLocked=r.isSoftLocked;n.isTemporararilyUnfrozen=r.isTemporararilyUnfrozen;n.isGoingToBeLockedSoon=r.isGoingToBeLockedSoon;n.isUnlockInProgress=r.isUnlockInProgress;n.quotaNeedsUpdate=n.createComputed(function(){return n._needsUpdate()});var i=new(n.managed(v))({data:n._requester.userDriveData});n.total=i.total;n.used=i.used;n.overage=i.overage;n.remaining=i.remaining;n.status=i.status;n.usedPercentage=i.usedPercentage;n.canUpgrade=i.canUpgrade;n.createBackgroundComputed(n._computeLogStatus);n.createBackgroundComputed(n._computeMonitorUrlForActiveUnlock).extend({deferred:!0});n.createBackgroundComputed(n._updateIfNeeded);return n}t.prototype.logEvent=function(e,t){var n=this._requester.userDriveData.peek();if(n&&n.quota){t=t||O.e.unknown;L.logData({name:O.e[t],scenario:A.e[e],quotaStatus:f.e[this.status.peek()],quotaTotal:n.quota.total,quotaUsed:n.quota.used,accountState:b.e[this.primaryLockedReason.peek()]})}};t.prototype.getNavigationUrl=function(e,t){var n=this._requester.userDriveData.peek();return this._quotaDataSource.getNavigationUrl({info:n?n.quota:null,isLocked:n&&n.status&&"active"!==n.status.state,status:this.status.peek(),destination:t,source:e})};t.prototype.unlockAccount=function(){var e=this;return this._quotaDataSource.unlockAccount().then(function(t){e._dataStore.setValue(P,t);e._triggerUnlockingState();if(e.isSoftLocked.peek()){e._monitorUnlocking(t);return s.n.resolve()}return e._monitorUnlocking(t)})};t.prototype.getSuspendedUrl=function(){return this._quotaDataSource.getSuspendedUrl()};t.prototype._computeMonitorUrlForActiveUnlock=function(){var e=this.accountState();if(2===e){var t=this._dataStore.getValue(P);if(t){this._triggerUnlockingState();this._monitorUnlocking(t)}}else 1===e&&this._dataStore.remove(P)};t.prototype._triggerUnlockingState=function(){this.isUnlockInProgress(!0)};t.prototype._updateIfNeeded=function(){if(this._needsUpdate()){this._requester.updateUserState();this._needsUpdate(!1)}};t.prototype._monitorUnlocking=function(e){var t=this;if(e)return this._operationMonitor.monitor(e).then(function(){t._dataStore.remove(P);window.location.reload()});this.async.setTimeout(function(){window.location.reload()},3e4)};t.prototype._computeLogStatus=function(){if(this.status()!==f.e.unknown){this.primaryLockedReason();this.logEvent(A.e.update,O.e.none)}};return t})(u.n);t.default=H}}]);